# 🚀 TgStyle с FastVLM - Новая Архитектура

## Обзор
Теперь FastVLM работает как постоянный сервер, а не запускается каждый раз при анализе!

## 🏗️ Архитектура

```
┌─────────────────┐    HTTP     ┌─────────────────┐
│   TgStyle App   │────────────►│  FastVLM Server │
│   (Node.js)     │             │  (Python/Flask) │
│   Port: 443     │◄────────────│  Port: 3001     │
└─────────────────┘             └─────────────────┘
         │                               │
         └───────────────────────────────┘
                  Модель в памяти
```

## 🚀 Запуск

### 1. Запуск основного сервера (автоматически запускает FastVLM)
```bash
npm run start
```

### 2. Что происходит при запуске:
1. **Node.js сервер** стартует на порту 443
2. **FastVLM сервер** автоматически запускается на порту 3001
3. **Модель загружается** в память FastVLM сервера
4. **Готово к анализу!** ✨

## 📡 API Endpoints

### FastVLM Server (Port 3001)
- `GET /health` - Проверка здоровья сервера
- `POST /analyze` - Анализ изображения

### Main Server (Port 443)
- `POST /api/analyze` - Анализ через Telegram Mini App

## 🔧 Технические Детали

### Преимущества новой архитектуры:
- ✅ **Быстрее**: Модель загружается один раз
- ✅ **Эффективнее**: Нет overhead от запуска Python процесса
- ✅ **Надежнее**: Лучше обработка ошибок
- ✅ **Масштабируемость**: Можно добавить несколько FastVLM серверов

### Мониторинг:
```bash
# Проверка здоровья FastVLM сервера
curl http://127.0.0.1:3001/health

# Логи основного сервера
tail -f server/logs/*.txt
```

## 🧪 Тестирование

### Тест FastVLM сервера:
```bash
python test_fastvlm_server.py
```

### Тест через приложение:
1. Откройте TgStyle в Telegram
2. Сделайте фото
3. Нажмите "Анализировать"
4. Увидите результат под фото!

## 🛠️ Устранение неполадок

### FastVLM сервер не запускается:
```bash
# Проверьте логи
tail -f server/logs/*.txt

# Проверьте Python окружение
source fastvlm_env/Scripts/activate
python -c "import torch; print('PyTorch OK')"
```

### Анализ возвращает симуляцию:
- FastVLM сервер недоступен
- Проверьте порт 3001: `netstat -an | grep 3001`
- Перезапустите сервер

### Ошибки кодировки:
- FastVLM может возвращать мусорные символы
- Система автоматически переключается на симуляцию
- Логи покажут детали ошибки

## 📊 Производительность

### Старая архитектура:
- Каждый анализ: ~30-60 секунд загрузки модели
- CPU/Memory overhead при каждом запуске

### Новая архитектура:
- Первый запуск: ~30-60 секунд загрузки модели
- Каждый анализ: ~5-15 секунд
- Модель в памяти постоянно

## 🔄 Обновления

При внесении изменений в FastVLM:
1. Остановите сервер: `Ctrl+C`
2. Перезапустите: `npm run start`
3. FastVLM сервер автоматически перезапустится с обновлениями

## 🎯 Результат

Теперь TgStyle имеет:
- ⚡ Быстрый анализ фотографий
- 🤖 Умную обработку через FastVLM
- 📱 Красивый интерфейс с результатами
- 💾 Сохранение истории анализов
- 🔄 Масштабируемую архитектуру
